{% extends 'base.html' %}

{% block title %}Room Types - Horizon Hotel{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col-md-12">
            <h1 class="display-6 mb-3">Our Room Types</h1>

            <!-- Room Type Filters -->
            <div class="card shadow mb-4">
                <div class="card-header bg-light">
                    <h2 class="h5 mb-0">Filter Options</h2>
                </div>
                <div class="card-body">
                    <form method="get" id="roomFilterForm">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label for="capacity" class="form-label">Capacity</label>
                                <select class="form-select" id="capacity" name="capacity">
                                    <option value="">Any</option>
                                    <option value="1" {% if request.args.get('capacity') == '1' %}selected{% endif %}>1 Person</option>
                                    <option value="2" {% if request.args.get('capacity') == '2' %}selected{% endif %}>2 People</option>
                                    <option value="3" {% if request.args.get('capacity') == '3' %}selected{% endif %}>3 People</option>
                                    <option value="4" {% if request.args.get('capacity') == '4' %}selected{% endif %}>4+ People</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="price_range" class="form-label">Price Range</label>
                                <select class="form-select" id="price_range" name="price_range">
                                    <option value="">Any</option>
                                    <option value="economy" {% if request.args.get('price_range') == 'economy' %}selected{% endif %}>Economy</option>
                                    <option value="standard" {% if request.args.get('price_range') == 'standard' %}selected{% endif %}>Standard</option>
                                    <option value="premium" {% if request.args.get('price_range') == 'premium' %}selected{% endif %}>Premium</option>
                                    <option value="luxury" {% if request.args.get('price_range') == 'luxury' %}selected{% endif %}>Luxury</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="amenities" class="form-label">Amenities</label>
                                <select class="form-select" id="amenities" name="amenities">
                                    <option value="">Any</option>
                                    <option value="view" {% if request.args.get('amenities') == 'view' %}selected{% endif %}>Ocean View</option>
                                    <option value="balcony" {% if request.args.get('amenities') == 'balcony' %}selected{% endif %}>Balcony</option>
                                    <option value="kitchen" {% if request.args.get('amenities') == 'kitchen' %}selected{% endif %}>Kitchenette</option>
                                </select>
                            </div>
                            <div class="col-md-3 d-flex align-items-end">
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="bi bi-filter"></i> Apply Filters
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Date Selection for Availability Check -->
            <div class="card shadow mb-4">
                <div class="card-header bg-light">
                    <h2 class="h5 mb-0">Check Availability</h2>
                </div>
                <div class="card-body">
                    <form method="get" id="availabilityForm">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label for="check_in_date" class="form-label">Check-in Date</label>
                                <input type="date" class="form-control" id="check_in_date" name="check_in_date"
                                       value="{{ request.args.get('check_in_date') or today_str }}" min="{{ today_str }}">
                            </div>
                            <div class="col-md-4">
                                <label for="check_out_date" class="form-label">Check-out Date</label>
                                <input type="date" class="form-control" id="check_out_date" name="check_out_date"
                                       value="{{ request.args.get('check_out_date') or tomorrow_str }}" min="{{ tomorrow_str }}">
                            </div>
                            <div class="col-md-4 d-flex align-items-end">
                                <button type="submit" class="btn btn-success w-100">
                                    <i class="bi bi-calendar-check"></i> Check Availability
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Room Types Display -->
            <div class="row">
                {% for room_type in room_types %}
                <div class="col-md-6 mb-4">
                    <div class="card shadow h-100">
                        <div class="card-header bg-light d-flex justify-content-between align-items-center">
                            <h3 class="h5 mb-0">{{ room_type.name }}</h3>
                            <span class="badge bg-primary">${{ "%.2f"|format(room_type.base_rate) }}/night</span>
                        </div>
                        <img src="{{ room_type.image_main }}" class="card-img-top" alt="{{ room_type.name }}" style="height: 200px; object-fit: cover;">
                        <div class="card-body">
                            <div class="mb-3">
                                <p class="card-text">{{ room_type.description }}</p>
                            </div>
                            <div class="mb-3">
                                <h4 class="h6">Room Features:</h4>
                                <ul class="list-unstyled row">
                                    <li class="col-md-6"><i class="bi bi-people me-2"></i> Capacity: {{ room_type.capacity }} person(s)</li>
                                    <li class="col-md-6"><i class="bi bi-rulers me-2"></i> Size: {{ room_type.size_sqm }} mÂ²</li>
                                    <li class="col-md-6"><i class="bi bi-door-open me-2"></i> {{ room_type.bed_type }}</li>
                                    {% if room_type.has_view %}
                                    <li class="col-md-6"><i class="bi bi-binoculars me-2"></i> Scenic View</li>
                                    {% endif %}
                                    {% if room_type.has_balcony %}
                                    <li class="col-md-6"><i class="bi bi-door-open-fill me-2"></i> Balcony</li>
                                    {% endif %}
                                    <li class="col-md-6"><i class="bi bi-wifi me-2"></i> Free Wi-Fi</li>
                                    <li class="col-md-6"><i class="bi bi-tv me-2"></i> Flat-screen TV</li>
                                </ul>
                            </div>
                            {% if room_type.amenities %}
                            <div class="mb-3">
                                <h4 class="h6">Amenities:</h4>
                                <p class="small">
                                    {% for amenity in room_type.amenities %}
                                        {{ amenity }}{% if not loop.last %}, {% endif %}
                                    {% endfor %}
                                </p>
                            </div>
                            {% endif %}

                            <!-- Availability Badge -->
                            {% if availability and room_type.id in availability %}
                                {% if availability[room_type.id] > 0 %}
                                <div class="alert alert-success">
                                    <i class="bi bi-check-circle me-2"></i> {{ availability[room_type.id] }} room(s) available for selected dates
                                </div>
                                {% else %}
                                <div class="alert alert-danger">
                                    <i class="bi bi-x-circle me-2"></i> No rooms available for selected dates
                                </div>
                                {% endif %}
                            {% endif %}
                        </div>
                        <div class="card-footer bg-white">
                            <div class="d-grid">
                                {% if availability and room_type.id in availability and availability[room_type.id] > 0 %}
                                <a href="{{ url_for('customer.new_booking', room_type_id=room_type.id, check_in_date=request.args.get('check_in_date'), check_out_date=request.args.get('check_out_date')) }}" class="btn btn-primary">
                                    <i class="bi bi-calendar-plus me-2"></i> Book Now
                                </a>
                                {% else %}
                                <button class="btn btn-secondary" disabled>
                                    <i class="bi bi-calendar-x me-2"></i> Not Available
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            {% if not room_types %}
            <div class="alert alert-info">
                <i class="bi bi-info-circle me-2"></i> No room types match your criteria. Please try different filters.
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const checkInDateEl = document.getElementById('check_in_date');
        const checkOutDateEl = document.getElementById('check_out_date');

        // Set minimum check-out date based on check-in date
        checkInDateEl.addEventListener('change', function() {
            if (checkInDateEl.value) {
                const checkInDate = new Date(checkInDateEl.value);
                checkInDate.setDate(checkInDate.getDate() + 1);
                const minCheckOutDate = checkInDate.toISOString().split('T')[0];
                checkOutDateEl.min = minCheckOutDate;

                // If check-out date is before new minimum, update it
                if (checkOutDateEl.value && checkOutDateEl.value < minCheckOutDate) {
                    checkOutDateEl.value = minCheckOutDate;
                }
            }
        });

        // Combine filter and availability forms
        const roomFilterForm = document.getElementById('roomFilterForm');
        const availabilityForm = document.getElementById('availabilityForm');

        roomFilterForm.addEventListener('submit', function(e) {
            e.preventDefault();

            // Combine parameters from both forms
            const filterParams = new URLSearchParams(new FormData(roomFilterForm));
            const availParams = new URLSearchParams(new FormData(availabilityForm));

            // Merge parameters
            for (const [key, value] of availParams.entries()) {
                filterParams.append(key, value);
            }

            // Redirect to the same page with combined parameters
            window.location.href = `${window.location.pathname}?${filterParams.toString()}`;
        });

        availabilityForm.addEventListener('submit', function(e) {
            e.preventDefault();

            // Combine parameters from both forms
            const availParams = new URLSearchParams(new FormData(availabilityForm));
            const filterParams = new URLSearchParams(new FormData(roomFilterForm));

            // Merge parameters
            for (const [key, value] of filterParams.entries()) {
                availParams.append(key, value);
            }

            // Redirect to the same page with combined parameters
            window.location.href = `${window.location.pathname}?${availParams.toString()}`;
        });
    });
</script>
{% endblock %}
