{% extends "base.html" %}

{% block title %}System Logs{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>System Logs</h1>
        <div>
            <a href="{{ url_for('admin.logs') }}" class="btn btn-primary me-2">
                <i class="bi bi-arrow-clockwise"></i> Refresh
            </a>
            <a href="{{ url_for('admin.dashboard') }}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Back to Dashboard
            </a>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h2 class="h5 mb-0">Log Viewer</h2>
            <small>Last updated: {{ last_updated }}</small>
        </div>
        <div class="card-body">
            {% if error %}
            <div class="alert alert-danger">
                {{ error }}
            </div>
            {% else %}
            <div class="mb-3">
                <div class="input-group">
                    <input type="text" class="form-control" id="logSearch" placeholder="Filter logs...">
                    <button class="btn btn-outline-secondary" type="button" id="clearSearch">Clear</button>
                </div>
                <div class="mt-2">
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="infoCheck" checked>
                        <label class="form-check-label" for="infoCheck">
                            <span class="badge bg-info">INFO</span>
                        </label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="warningCheck" checked>
                        <label class="form-check-label" for="warningCheck">
                            <span class="badge bg-warning">WARNING</span>
                        </label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="errorCheck" checked>
                        <label class="form-check-label" for="errorCheck">
                            <span class="badge bg-danger">ERROR</span>
                        </label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="debugCheck" checked>
                        <label class="form-check-label" for="debugCheck">
                            <span class="badge bg-secondary">DEBUG</span>
                        </label>
                    </div>
                </div>
            </div>
            
            <div class="table-responsive">
                <table class="table table-striped table-hover" id="logTable">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Level</th>
                            <th>Message</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for log in logs %}
                        <tr class="log-entry {{ log.level.lower() }}-level">
                            <td>{{ log.timestamp }}</td>
                            <td>
                                <span class="badge bg-{{ 'info' if log.level == 'INFO' else 'warning' if log.level == 'WARNING' else 'danger' if log.level == 'ERROR' else 'secondary' }}">
                                    {{ log.level }}
                                </span>
                            </td>
                            <td>{{ log.message }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endif %}
        </div>
    </div>

    <div class="card">
        <div class="card-header bg-info text-white">
            <h2 class="h5 mb-0">About System Logs</h2>
        </div>
        <div class="card-body">
            <p>This page displays the most recent system logs (up to 500 entries). Use the filter options above to narrow down the displayed logs.</p>
            <p><strong>Log Levels:</strong></p>
            <ul>
                <li><span class="badge bg-info">INFO</span> - General information about system operation</li>
                <li><span class="badge bg-warning">WARNING</span> - Issues that might require attention but don't impact system operation</li>
                <li><span class="badge bg-danger">ERROR</span> - Problems that may impair system functionality</li>
                <li><span class="badge bg-secondary">DEBUG</span> - Detailed diagnostic information</li>
            </ul>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const logSearch = document.getElementById('logSearch');
        const clearSearch = document.getElementById('clearSearch');
        const infoCheck = document.getElementById('infoCheck');
        const warningCheck = document.getElementById('warningCheck');
        const errorCheck = document.getElementById('errorCheck');
        const debugCheck = document.getElementById('debugCheck');
        const logTable = document.getElementById('logTable');
        
        // Function to filter the table based on search and checkboxes
        function filterTable() {
            const searchText = logSearch.value.toLowerCase();
            const showInfo = infoCheck.checked;
            const showWarning = warningCheck.checked;
            const showError = errorCheck.checked;
            const showDebug = debugCheck.checked;
            
            // Get all rows in the table body
            const rows = logTable.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
            
            // Loop through each row and apply filters
            for (let row of rows) {
                const text = row.textContent.toLowerCase();
                const isInfoRow = row.classList.contains('info-level');
                const isWarningRow = row.classList.contains('warning-level');
                const isErrorRow = row.classList.contains('error-level');
                const isDebugRow = row.classList.contains('debug-level');
                
                // Check if row matches all filters
                const matchesSearchText = searchText === '' || text.includes(searchText);
                const matchesLevelFilter = 
                    (isInfoRow && showInfo) || 
                    (isWarningRow && showWarning) ||
                    (isErrorRow && showError) ||
                    (isDebugRow && showDebug) ||
                    (!isInfoRow && !isWarningRow && !isErrorRow && !isDebugRow); // For other levels
                
                // Show or hide the row
                row.style.display = (matchesSearchText && matchesLevelFilter) ? '' : 'none';
            }
        }
        
        // Add event listeners
        logSearch.addEventListener('input', filterTable);
        clearSearch.addEventListener('click', function() {
            logSearch.value = '';
            filterTable();
        });
        
        infoCheck.addEventListener('change', filterTable);
        warningCheck.addEventListener('change', filterTable);
        errorCheck.addEventListener('change', filterTable);
        debugCheck.addEventListener('change', filterTable);
    });
</script>
{% endblock %} 